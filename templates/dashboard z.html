<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Management Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #3498db;
      --secondary-color: #2980b9;
      --background-color: #f8f9fa;
      --card-color: #ffffff;
      --text-color: #333333;
      --border-color: #e0e0e0;
      --success-color: #2ecc71;
      --warning-color: #f39c12;
      --danger-color: #e74c3c;
      --info-color: #3498db;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
      --store-dropdown-color: #e8f4f8;
      --supplier-dropdown-color: #f0f8e8;
      --reset-button-color: #ff6b6b;
      --reset-button-hover: #ff5252;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      background-color: var(--card-color);
      padding: 20px;
      border-radius: 8px;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header h1 {
      font-size: 24px;
      color: var(--text-color);
      font-weight: 600;
    }
    
    .search-container {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }
    
    .search-box {
      position: relative;
      flex: 1;
      min-width: 200px;
      background-color: var(--card-color);
      border-radius: 8px;
      padding: 15px;
      box-shadow: var(--shadow);
    }
    
    .search-box input {
      width: 100%;
      padding: 10px 15px 10px 35px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 14px;
      transition: var(--transition);
    }
    
    .search-box input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }
    
    .dropdown-results {
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      background: white;
      border: 1px solid var(--border-color);
      border-top: none;
      border-radius: 0 0 6px 6px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .dropdown-results div {
      padding: 8px 12px;
      cursor: pointer;
    }
    
    .dropdown-results div:hover,
    .dropdown-results .highlight {
      background-color: rgba(52, 152, 219, 0.1);
    }
    
    .dropdown-results.store div:hover,
    .dropdown-results.store .highlight {
      background-color: var(--store-dropdown-color);
    }
    
    .dropdown-results.supplier div:hover,
    .dropdown-results.supplier .highlight {
      background-color: var(--supplier-dropdown-color);
    }
    
    .table-container {
      background-color: var(--card-color);
      border-radius: 8px;
      box-shadow: var(--shadow);
      overflow: hidden;
      margin-bottom: 25px;
      position: relative;
    }
    
    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      background-color: #f5f7fa;
      border-bottom: 1px solid var(--border-color);
    }
    
    .table-header h2 {
      font-size: 18px;
      font-weight: 600;
    }
    
    .table-info {
      font-size: 14px;
      color: #666;
    }
    
    .grid {
      width: 100%;
      border-collapse: collapse;
      background: #fafafa;
      border: 1px solid #ccc;
    }
    
/* CSS Reset */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

/* Apply to the S.No column */
.grid th:nth-child(1),
.grid td:nth-child(1) {
  text-align: center !important;
  vertical-align: middle !important;
}

/* Apply to the Qty column */
.grid th:nth-child(4),
.grid td:nth-child(4) {
  text-align: center !important;
  vertical-align: middle !important;
}

/* Apply to the Unit column */
.grid th:nth-child(6),
.grid td:nth-child(6) {
  text-align: center !important;
  vertical-align: middle !important;
}

/* Apply to both header and body cells */
.grid th,
.grid td {
  height: 25px !important;
  min-height: 25px !important;
  max-height: 25px !important;
  padding: 6px 3px !important;
  font-size: 14px !important;
  line-height: 1 !important;
  vertical-align: middle !important;
  box-sizing: border-box !important;
  overflow: hidden !important;
  white-space: nowrap !important;
  border: 1px solid #ddd !important;
  text-align: center !important; /* Center the text */
}

/* Ensure row height consistency */
.grid tr {
  height: 25px !important;
  min-height: 25px !important;
  max-height: 25px !important;
}

/* Reset or override any existing styles */
.grid th,
.grid td {
  text-align: center !important;
  vertical-align: middle !important;
}
    /* More specific selector for table cells */
    #dgvMain tr td,
    #dgvMain tr th {
      height: 25px !important;
      min-height: 25px !important;
      max-height: 25px !important;
      padding: 6px 3px !important;
      font-size: 14px !important;
      line-height: 1 !important;
      vertical-align: middle !important;
      box-sizing: border-box !important;
      overflow: hidden !important;
      white-space: nowrap !important;
      border: 1px solid #ddd !important;
      text-align: left !important;
    }
    
    /* Ensure row height consistency */
    #dgvMain tr {
      height: 25px !important;
      min-height: 25px !important;
      max-height: 25px !important;
    }
    
/* Input field inside table cells */
.grid input[type="number"] {
  height: 22px !important;
  padding: 0 !important;
  font-size: 14px !important;
  line-height: 1 !important;
  margin: 0 !important;
  border: 1px solid #ccc !important;
  box-sizing: border-box !important;
  display: block;
  width: 55px !important;
  text-align: center !important; /* Center the text inside the input */
  vertical-align: middle !important; /* Center the input vertically */
  margin-top: -2px !important; /* Adjust this value as needed to fine-tune vertical alignment */
}
    
    /* Optional chart placeholder */
    .chart-placeholder {
      height: 200px;
      background: #d1eaff;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      color: #0077cc;
    }
    
    /* Decrease the height of table rows */
    tr {
      height: 25px !important; /* Adjust this value as needed */
    }
    
    /* Decrease the height of table cells */
    td, th {
      height: 25px !important; /* Adjust this value as needed */
      padding: 6px 3px !important; /* Adjust padding if needed */
    }
    
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .header h1 {
        margin-bottom: 10px;
      }
      
      .search-container {
        flex-direction: column;
      }
      
      .search-box {
        width: 100%;
      }
      
      .table-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .table-info {
        margin-top: 10px;
      }
      
      .actions {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Welcome, {{ user }}</h1>
    </div>
    
    <div class="search-container">
      <div class="search-box">
        <i class="fas fa-store"></i>
        <input type="text" id="storeSearch" placeholder="Search Store" autocomplete="off">
        <div id="storeDropdown" class="dropdown-results store" style="display: none;"></div>
      </div>
      <div class="search-box">
        <i class="fas fa-truck"></i>
        <input type="text" id="supplierSearch" placeholder="Search Supplier" autocomplete="off">
        <div id="supplierDropdown" class="dropdown-results supplier" style="display: none;"></div>
      </div>
    </div>
    
    <div class="table-container">
      <div class="table-header">
        <h2>Order Details</h2>
        <div class="table-info" id="table-info">Showing 0 of 0 products</div>
      </div>
      <div style="position: relative; height: 400px; overflow-y: auto;">
        <table id="dgvMain" class="grid">
          <thead>
            <tr>
              <th style="width: 60px; text-align: center;">S.No</th>
              <th style="width: 120px;">Product Code</th>
              <th style="width: 200px;">Product Name</th>
              <th style="width: 80px; text-align: center;">Qty</th>
              <th style="width: 120px; text-align: center;">Edit Qty</th>
              <th style="width: 100px; text-align: center;">Unit</th>
              <th style="width: 200px;">Remarks</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
        <div class="loading-overlay" id="loading-overlay">
          <div class="spinner"></div>
        </div>
      </div>
      <div class="actions">
        <button class="btn btn-reset" id="resetBtn">Reset</button>
        <button class="btn btn-primary" id="submitBtn">Submit Changes</button>
      </div>
    </div>
    
    <div class="pagination" id="pagination">
      <!-- Pagination will be added here dynamically -->
    </div>
  </div>
  
  <div class="notification" id="notification">
    <div class="notification-title" id="notification-title"></div>
    <div class="notification-message" id="notification-message"></div>
  </div>
  
  <footer>
    <p>Â© 2023 Order Management Dashboard. All rights reserved.</p>
  </footer>
  
  <script>
    // Configuration
    const ITEMS_PER_PAGE = 20;
    let currentPage = 1;
    let totalItems = 0;
    let allData = [];
    let selectedStore = '';
    let selectedSupplierCode = '';
    
    // DOM Elements
    const storeSearch = document.getElementById('storeSearch');
    const storeDropdown = document.getElementById('storeDropdown');
    const supplierSearch = document.getElementById('supplierSearch');
    const supplierDropdown = document.getElementById('supplierDropdown');
    const tableBody = document.querySelector('#dgvMain tbody');
    const tableInfo = document.getElementById('table-info');
    const loadingOverlay = document.getElementById('loading-overlay');
    const submitBtn = document.getElementById('submitBtn');
    const resetBtn = document.getElementById('resetBtn');
    const paginationContainer = document.getElementById('pagination');
    const notification = document.getElementById('notification');
    const notificationTitle = document.getElementById('notification-title');
    const notificationMessage = document.getElementById('notification-message');
    
    // Helper Functions
    function showLoading() {
      loadingOverlay.style.display = 'flex';
    }
    
    function hideLoading() {
      loadingOverlay.style.display = 'none';
    }
    
    function showNotification(title, message, type = 'info') {
      notification.className = 'notification show ' + type;
      notificationTitle.textContent = title;
      notificationMessage.textContent = message;
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }
    
    function updateTableInfo() {
      const start = (currentPage - 1) * ITEMS_PER_PAGE + 1;
      const end = Math.min(start + ITEMS_PER_PAGE - 1, totalItems);
      tableInfo.textContent = `Showing ${start}-${end} of ${totalItems} products`;
    }
    
    function createPagination() {
      const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
      paginationContainer.innerHTML = '';
      
      // Previous button
      const prevBtn = document.createElement('button');
      prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
      prevBtn.disabled = currentPage === 1;
      prevBtn.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          render();
          createPagination();
        }
      });
      paginationContainer.appendChild(prevBtn);
      
      // Page buttons
      const maxVisiblePages = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
      
      if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }
      
      for (let i = startPage; i <= endPage; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.textContent = i;
        pageBtn.className = i === currentPage ? 'active' : '';
        pageBtn.addEventListener('click', () => {
          currentPage = i;
          renderTable();
          createPagination();
        });
        paginationContainer.appendChild(pageBtn);
      }
      
      // Next button
      const nextBtn = document.createElement('button');
      nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
      nextBtn.disabled = currentPage === totalPages;
      nextBtn.addEventListener('click', () => {
        if (currentPage < totalPages) {
          currentPage++;
          renderTable();
          createPagination();
        }
      });
      paginationContainer.appendChild(nextBtn);
    }
    
    function updateRemark(cell, newValue, originalValue) {
      const qty = parseInt(newValue, 10);
      let remarkHTML = '';
      
      if (isNaN(qty) || qty <= 0) {
        remarkHTML = `<i class="fas fa-times-circle"></i> Not Available`;
        cell.className = 'remark status-danger';
      } else if (qty < originalValue) {
        remarkHTML = `<i class="fas fa-arrow-down"></i> Only Available Edit Qty`;
        cell.className = 'remark status-warning';
      } else if (qty > originalValue) {
        remarkHTML = `<i class="fas fa-arrow-up"></i> Qty Increased`;
        cell.className = 'remark status-info';
      } else {
        remarkHTML = `<i class="fas fa-check"></i> Available`;
        cell.className = 'remark status-available';
      }
      
      cell.innerHTML = remarkHTML;
    }
    
    // Search Box Setup
    function setupSearchBox(inputId, dropdownId, endpoint, onSelectCallback) {
      const input = document.getElementById(inputId);
      const dropdown = document.getElementById(dropdownId);
      let suggestions = [];
      let currentIndex = -1;
      
      // Mouse events
      input.addEventListener('input', async () => {
        const query = input.value.trim();
        if (!query) {
          dropdown.style.display = 'none';
          return;
        }
        
        let url = endpoint + '?q=' + encodeURIComponent(query);
        if (inputId === 'supplierSearch' && selectedStore) {
          url += '&store=' + encodeURIComponent(selectedStore);
        }
        
        showLoading();
        try {
          console.log(`Fetching from URL: ${url}`); // Debug log
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          console.log('Response received:', response); // Debug log
          suggestions = await response.json();
          console.log('Suggestions:', suggestions); // Debug log
          dropdown.innerHTML = '';
          currentIndex = -1;
          
          if (suggestions.length > 0) {
            suggestions.forEach(item => {
              const div = document.createElement('div');
              div.textContent = item;
              div.onclick = () => selectItem(item);
              dropdown.appendChild(div);
            });
            dropdown.style.display = 'block';
          } else {
            dropdown.style.display = 'none';
          }
        } catch (error) {
          console.error('Error fetching suggestions:', error); // Debug log
          dropdown.style.display = 'none';
        } finally {
          hideLoading();
        }
      });
      
      // Keyboard events for navigation
      input.addEventListener('keydown', e => {
        const items = dropdown.querySelectorAll('div');
        
        // If dropdown is not visible but has suggestions, show it
        if ((e.key === 'ArrowDown' || e.key === 'ArrowUp') && suggestions.length > 0 && dropdown.style.display === 'none') {
          dropdown.style.display = 'block';
        }
        
        if (e.key === 'ArrowDown') {
          currentIndex = (currentIndex + 1) % items.length;
          updateHighlight(items);
          e.preventDefault(); // Prevent caret movement
        } else if (e.key === 'ArrowUp') {
          currentIndex = (currentIndex - 1 + items.length) % items.length;
          updateHighlight(items);
          e.preventDefault();
        } else if (e.key === 'Enter') {
          if (currentIndex >= 0 && suggestions[currentIndex]) {
            selectItem(suggestions[currentIndex]);
            e.preventDefault();
          } else if (suggestions.length > 0) {
            // If no item is selected but there are suggestions, select the first one
            currentIndex = 0;
            updateHighlight(items);
            e.preventDefault();
          }
        } else if (e.key === 'Escape') {
          dropdown.style = 'none';
        }
      });
      
      function updateHighlight(items) {
        items.forEach((item, i) => item.classList.toggle('highlight', i === currentIndex));
      }
      
      function selectItem(name) {
        input.value = name;
        dropdown.style.display = 'none';
        if (onSelectCallback) {
          onSelectCallback(name);
          // Auto-focus supplier search after selecting store
          if (inputId === 'storeSearch') {
            supplierSearch.focus();
          }
        }
      }
      
      document.addEventListener('click', e => {
        if (!e.target.closest('.search-wrapper')) {
          dropdown.style.display = 'none';
        }
      });
    }
    
    // Load Orders
    async function loadOrders() {
      if (!selectedSupplierCode || !selectedStore) return;
      
      showLoading();
      try {
        const response = await fetch(`/get_orders?suppliercode=${encodeURIComponent(selectedSupplierCode)}&storename=${encodeURIComponent(selectedStore)}`);
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        allData = await response.json();
        totalItems = allData.length;
        currentPage = 1; // Reset to first page when loading new data
        
        if (totalItems === 0) {
          tableBody.innerHTML = `<tr><td colspan="7" style="color: red; text-align: center;">No Order Placed for this Supplier</td></tr>`;
          paginationContainer.innerHTML = '';
          tableInfo.textContent = `Showing 0 of 0 products`;
          return;
        }
        
        renderTable();
        createPagination();
      } catch (error) {
        console.error('Error loading orders:', error);
        showNotification('Error', 'Failed to load order data', 'error');
      } finally {
        hideLoading();
      }
    }
    
    function renderTable() {
  tableBody.innerHTML = '';
  const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
  const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, totalItems);
  
  for (let i = startIndex; i < endIndex; i++) {
    const row = allData[i];
    const rowNumber = i + 1; // Corrected row numbering
    const originalValue = row.OrderQty;
    const editCell = document.createElement('td');
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="text-align: center;">${rowNumber}</td>
      <td>${row.ProductCode}</td>
      <td>${row.ProductName}</td>
      <td style="text-align: center;">${row.OrderQty}</td>
      <td></td>
      <td style="text-align: center;">${row.SaleUnit}</td>
      <td></td>
    `;
    
    const editQtyInput = document.createElement('input');
    editQtyInput.type = 'number';
    editQtyInput.value = row.OrderQty;
    editQtyInput.className = 'edit-qty';
    editQtyInput.dataset.original = originalValue;
    editQtyInput.addEventListener('input', () => {
      const remarkCell = tr.querySelector('td:nth-child(7)');
      updateRemark(remarkCell, editQtyInput.value, originalValue);
    });
    
    editCell.appendChild(editQtyInput);
    const editQtyCell = tr.children[4];
    editQtyCell.appendChild(editQtyInput);
    const remarkCell = tr.querySelector('td:nth-child(7)');
    updateRemark(remarkCell, editQtyInput.value, originalValue);
    
    tableBody.appendChild(tr);
  }
  
  updateTableInfo();
}
    
    // Initialize
    function init() {
      // Setup search boxes
      setupSearchBox('storeSearch', 'storeDropdown', '/search_store', store => {
        selectedStore = store;
      });
      
      setupSearchBox('supplierSearch', 'supplierDropdown', '/search_supplier', supplier => {
        if (!selectedStore) return;
        fetch(`/get_suppliercode?suppliername=${encodeURIComponent(supplier)}&storename=${encodeURIComponent(selectedStore)}`)
          .then(res => res.json())
          .then(data => {
            selectedSupplierCode = data.suppliercode;
            if (selectedSupplierCode) loadOrders();
          });
      });
      
      // Setup buttons
      submitBtn.addEventListener('click', () => {
        if (!selectedSupplierCode || !selectedStore) {
          showNotification('Error', 'Please select a store and supplier first', 'error');
          return;
        }
        
        const updatedData = [];
        const rows = tableBody.querySelectorAll('tr');
        
        rows.forEach((row, index) => {
          const cells = row.querySelectorAll('td');
          const editQtyInput = cells[4].querySelector('input');
          const qty = parseInt(editQtyInput.value, 10);
          
          if (!isNaN(qty) && qty > 0) {
            updatedData.push({
              ProductCode: cells[1].textContent,
              NewQty: qty,
              OriginalQty: parseInt(editQtyInput.dataset.original, 10)
            });
          }
        });
        
        if (updatedData.length > 0) {
          showLoading();
          fetch('/update_orders', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              suppliercode: selectedSupplierCode,
              storename: selectedStore,
              updatedData: updatedData
            })
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              showNotification('Success', `Updated ${updatedData.length} items`, 'success');
              loadOrders(); // Reload the table
            } else {
              showNotification('Error', 'Failed to update order quantities', 'error');
            }
          })
          .catch(error => {
            console.error('Error updating orders:', error);
            showNotification('Error', 'Failed to update order quantities', 'error');
          })
          .finally(() => {
            hideLoading();
          });
        } else {
          showNotification('Info', 'No changes to submit', 'info');
        }
      });
      
      resetBtn.addEventListener('click', () => {
        if (!selectedSupplierCode || !selectedStore) return;
        loadOrders();
        showNotification('Info', 'Table has been reset to original values', 'info');
      });
    }
    
    // Initialize the application when the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>